<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>
<script src="/peer.js"></script>
<style>
  body {
    margin:0;
    background:#121212;
    color:#eee;
    font-family:system-ui,sans-serif;
    text-align:center;
  }

  .centerBox {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:#1e1e1e;
    border:1px solid #333;
    border-radius:12px;
    padding:2rem;
    width:90%;
    max-width:380px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }

  input, button {
    font-size:1rem;
    padding:0.6rem 0.8rem;
    border-radius:8px;
    border:none;
    margin:0.5rem 0;
    width:100%;
    box-sizing:border-box;
  }

  input { background:#2a2a2a; color:#eee; }
  button { background:#0b74de; color:white; cursor:pointer; }
  button:hover { background:#095ab0; }

  #connectedUI {
    display:none;
    height:100vh;
    width:100vw;
    background:#111;
    display:flex;
    flex-direction:column;
  }

  #topbar {
    display:flex;
    padding:0.5rem;
    background:#1e1e1e;
    border-bottom:1px solid #333;
  }

  #urlInput {
    flex:1;
    margin-right:0.5rem;
    border-radius:6px;
  }

  #browser {
    flex:1;
    overflow:auto;
    padding:1rem;
    background:#111;
    text-align:left;
  }

  .link {
    color:#4aa3ff;
    cursor:pointer;
    margin-top:0.8rem;
    display:inline-block;
  }

  #browser iframe {
    width:100%;
    height:100%;
    border:none;
  }
</style>
</head>
<body>

<!-- PHONE UI -->
<div class="centerBox" id="phoneUI">
  <h2>Your Code</h2>
  <div id="phoneCode" style="font-size:2rem;font-weight:bold;margin:1rem 0;">------</div>
  <button id="resetCodeBtn">Reset Code</button>
  <div class="link" id="switchToComputer">I'm not on mobile</div>
</div>

<!-- COMPUTER UI -->
<div class="centerBox" id="computerUI">
  <h2>Enter Phone Code</h2>
  <input id="codeInput" maxlength="6" placeholder="6-digit code"/>
  <button id="connectBtn" disabled>Connect</button>
  <div class="link" id="switchToPhone">I'm not on phone</div>
</div>

<!-- CONNECTED UI -->
<div id="connectedUI">
  <div id="topbar">
    <input id="urlInput" placeholder="Enter URL"/>
    <button id="sendBtn">Go</button>
  </div>
  <div id="browser"></div>
</div>

<script>
(() => {
  const phoneUI = document.getElementById('phoneUI');
  const computerUI = document.getElementById('computerUI');
  const connectedUI = document.getElementById('connectedUI');
  const phoneCodeEl = document.getElementById('phoneCode');
  const resetCodeBtn = document.getElementById('resetCodeBtn');
  const switchToComputer = document.getElementById('switchToComputer');
  const switchToPhone = document.getElementById('switchToPhone');
  const codeInput = document.getElementById('codeInput');
  const connectBtn = document.getElementById('connectBtn');
  const urlInput = document.getElementById('urlInput');
  const sendBtn = document.getElementById('sendBtn');
  const browserEl = document.getElementById('browser');

  let peer = null;
  let conn = null;
  let myCode = null;
  let role = /Mobi|Android/i.test(navigator.userAgent) ? 'phone' : 'computer';

  function resetUI() {
    phoneUI.style.display = "none";
    computerUI.style.display = "none";
    connectedUI.style.display = "none";
  }

  function getOrCreateCode(reset=false) {
    if (!reset && myCode) return myCode;
    myCode = localStorage.getItem("phoneCode");
    if (!myCode || reset) {
      myCode = String(Math.floor(100000 + Math.random() * 900000));
      localStorage.setItem("phoneCode", myCode);
    }
    return myCode;
  }

  function showPhoneUI() {
    role = 'phone';
    resetUI();
    phoneUI.style.display = "block";
    phoneCodeEl.textContent = getOrCreateCode();
    setupPeer(getOrCreateCode());
  }

  function showComputerUI() {
    role = 'computer';
    resetUI();
    computerUI.style.display = "block";
    setupPeer();
  }

  function showConnectedUI() {
    resetUI();
    connectedUI.style.display = "flex";
  }

  resetCodeBtn.onclick = () => showPhoneUI(true);
  switchToComputer.onclick = showComputerUI;
  switchToPhone.onclick = showPhoneUI;

  codeInput.addEventListener("input", () => {
    connectBtn.disabled = codeInput.value.length !== 6;
  });

  connectBtn.onclick = () => {
    const target = codeInput.value.trim();
    if (!target || !peer) return;
    conn = peer.connect(target);
    conn.on('open', showConnectedUI);
    conn.on('data', onData);
  };

  function setupPeer(id) {
    if (peer) peer.destroy();
    peer = new Peer(id);
    peer.on('connection', c => {
      conn = c;
      c.on('open', showConnectedUI);
      c.on('data', onData);
    });
  }

  function proxy(url) {
    return "https://corsproxy.io/?" + encodeURIComponent(url);
  }

  async function onData(data) {
    if (role === 'phone' && data.type === 'fetch') {
      try {
        const res = await fetch(proxy(data.url));
        const text = await res.text();
        conn.send({type:'html', html:text, base:data.url});
      } catch(e) {
        conn.send({type:'html', html:'<pre>Error: '+e+'</pre>', base:data.url});
      }
    }
    if (role === 'computer' && data.type === 'html') {
      render(data.html, data.base);
    }
  }

  function render(html, baseUrl) {
    const doc = new DOMParser().parseFromString(html, "text/html");
    const base = new URL(baseUrl);

    doc.querySelectorAll('[href]').forEach(el => {
      const v = el.getAttribute('href');
      if (v && !v.startsWith('http')) el.setAttribute('href', new URL(v, base).href);
      el.onclick = e => { e.preventDefault(); urlInput.value = el.href; sendBtn.click(); };
    });

    doc.querySelectorAll('[src]').forEach(el => {
      const v = el.getAttribute('src');
      if (v && !v.startsWith('http')) el.setAttribute('src', new URL(v, base).href);
      el.setAttribute('src', proxy(el.src));
    });

    const sandbox = document.createElement('iframe');
    sandbox.sandbox = "allow-same-origin allow-scripts allow-forms";
    sandbox.srcdoc = "<base href='"+base.href+"'>" + doc.documentElement.outerHTML;

    browserEl.innerHTML = "";
    browserEl.appendChild(sandbox);
  }

  sendBtn.onclick = () => {
    const url = urlInput.value.trim();
    if (!url || !conn) return;
    conn.send({type:'fetch', url});
  };

  if (role === 'phone') showPhoneUI(); else showComputerUI();
})();
</script>
</body>
</html>
