<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>

<script src="/peer.js"></script>

<style>
body {
  margin:0;
  background:#121212;
  color:#eee;
  font-family:system-ui,sans-serif;
  text-align:center;
}
.centerBox {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#1e1e1e;
  border:1px solid #333;
  border-radius:12px;
  padding:2rem;
  width:90%;
  max-width:380px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#connectedUI {
  display:none;
  height:100vh;
  flex-direction:column;
}
#topbar {
  display:flex;
  gap:0.5rem;
  padding:0.5rem;
  background:#1e1e1e;
  border-bottom:1px solid #333;
}
#urlInput {
  flex:1;
  padding:0.5rem;
  border-radius:6px;
  border:1px solid #555;
  background:#2a2a2a;
  color:#eee;
}
#sendBtn {
  padding:0.45rem 0.8rem;
  border-radius:6px;
  border:none;
  background:#0b74de;
  color:white;
  cursor:pointer;
}
#browserHost {
  flex:1;
  overflow:auto;
  background:#fff;
}
</style>
</head>
<body>

<div class="centerBox" id="phoneUI" hidden>
  <h1>Your Code</h1>
  <div style="font-size:2rem;font-weight:bold;margin:1rem 0;" id="phoneCode">------</div>
  <button id="resetCodeBtn">Reset Code</button>
</div>

<div id="phoneConnectedUI" hidden>
  <div style="padding:1rem;background:#111;border-bottom:1px solid #333;display:flex;justify-content:space-between;">
    <div>
      <div>Connected ✓</div>
      <div id="uptime">Uptime 0s</div>
    </div>
    <button id="disconnectBtn">Disconnect</button>
  </div>
</div>

<div class="centerBox" id="computerUI" hidden>
  <h1>Enter Phone Code</h1>
  <input id="codeInput" maxlength="6" placeholder="6-digit code"/>
  <button id="connectBtn" disabled>Connect</button>
</div>

<div id="connectedUI">
  <div id="topbar">
    <input id="urlInput" placeholder="Enter URL"/>
    <button id="sendBtn">Go</button>
  </div>
  <div id="browserHost"></div>
</div>

<script>
(() => {
let role=/Mobi|Android/i.test(navigator.userAgent)?"phone":"computer";
let peer=null,conn=null,myCode=null,uptimeTimer=null,connectTime=null,lastUrl=null;
const phoneUI=document.getElementById("phoneUI");
const phoneConnectedUI=document.getElementById("phoneConnectedUI");
const phoneCodeEl=document.getElementById("phoneCode");
const resetCodeBtn=document.getElementById("resetCodeBtn");
const uptimeEl=document.getElementById("uptime");
const disconnectBtn=document.getElementById("disconnectBtn");
const computerUI=document.getElementById("computerUI");
const connectedUI=document.getElementById("connectedUI");
const codeInput=document.getElementById("codeInput");
const connectBtn=document.getElementById("connectBtn");
const urlInput=document.getElementById("urlInput");
const sendBtn=document.getElementById("sendBtn");
const browserHost=document.getElementById("browserHost");
const shadowRoot=browserHost.attachShadow({mode:"open"});
const pending={};

function resetUI(){
  phoneUI.hidden=true; phoneConnectedUI.hidden=true;
  computerUI.hidden=true; connectedUI.style.display="none";
}
function showPhoneCode(){resetUI();phoneUI.hidden=false;}
function showPhoneConnected(){resetUI();phoneConnectedUI.hidden=false;}
function showComputer(){resetUI();computerUI.hidden=false;}
function showComputerConnected(){resetUI();connectedUI.style.display="flex";}

function initPeer(id){
  if(peer) return;
  peer=new Peer(id);
  peer.on("connection",c=>{conn=c;wireConn();});
}
function wireConn(){
  conn.on("open",onConnected);
  conn.on("data",onData);
  conn.on("close",onDisconnected);
}
function onConnected(){
  connectTime=Date.now();
  if(role==="phone"){
    showPhoneConnected();
    uptimeTimer=setInterval(()=>uptimeEl.textContent="Uptime "+Math.floor((Date.now()-connectTime)/1000)+"s",1000);
  } else showComputerConnected();
}
function onDisconnected(){
  if(uptimeTimer){clearInterval(uptimeTimer);uptimeTimer=null;}
  conn=null;
  role==="phone"?showPhoneCode():showComputer();
}

async function onData(d){
  if(role==="phone"&&d.type==="fetch-request"){
    try{
      const r=await fetch("https://corsproxy.io/?"+encodeURIComponent(d.url));
      const buf=await r.arrayBuffer();
      conn.send({type:"fetch-response",body:buf,url:d.url,ctype:r.headers.get("content-type")});
    }catch(e){
      conn.send({type:"fetch-response",body:null,error:String(e),url:d.url});
    }
  }
  if(role==="computer"&&d.type==="fetch-response"){
    if(d.ctype && !d.ctype.includes("text/html")){
      const blob=new Blob([d.body],{type:d.ctype});
      const url=URL.createObjectURL(blob);
      pending[d.url]?.(url);
      delete pending[d.url];
    } else {
      renderPage(new TextDecoder().decode(d.body), d.url||lastUrl);
    }
  }
}

function proxyAsset(url){
  return new Promise(res=>{
    pending[url]=res;
    conn.send({type:"fetch-request",url});
  });
}

function scopeCSS(css){
  return css.replace(/(^|\})\s*([^{]+)/g,(m,p,sel)=>{
    if(sel.includes("@")) return m;
    return `${p} :host ${sel}`;
  });
}

async function renderPage(html,baseUrl){
  const doc=new DOMParser().parseFromString(html,"text/html");
  const base=new URL(baseUrl);
  doc.querySelectorAll("script").forEach(s=>s.remove());

  for(const el of doc.querySelectorAll("[href]")){
    const h=el.getAttribute("href");
    if(!h) continue;
    const abs=new URL(h,base).href;
    el.removeAttribute("href");
    el.style.cursor="pointer";
    el.onclick=()=>requestUrl(abs);
  }

  for(const el of doc.querySelectorAll("[src]")){
    const s=el.getAttribute("src");
    if(!s) continue;
    const abs=new URL(s,base).href;
    const blobUrl=await proxyAsset(abs);
    el.setAttribute("src",blobUrl);
  }

  for(const el of doc.querySelectorAll("link[rel=stylesheet]")){
    const href=el.getAttribute("href");
    if(!href) continue;
    const abs=new URL(href,base).href;
    const cssBlob=await proxyAsset(abs);
    const raw=await fetch(cssBlob).then(r=>r.text());
    const style=document.createElement("style");
    style.textContent=scopeCSS(raw);
    el.replaceWith(style);
  }

  shadowRoot.innerHTML="";
  shadowRoot.appendChild(doc.body);
}

function requestUrl(url){
  if(!conn) return;
  lastUrl=url;
  shadowRoot.innerHTML="<p style='font-family:sans-serif;padding:1rem'>Loading…</p>";
  conn.send({type:"fetch-request",url});
}

if(role==="phone"){
  myCode=localStorage.getItem("phoneCode")||String(Math.floor(100000+Math.random()*900000));
  localStorage.setItem("phoneCode",myCode);
  phoneCodeEl.textContent=myCode;
  initPeer(myCode);
  showPhoneCode();
}else{
  initPeer();
  showComputer();
}

codeInput.oninput=()=>connectBtn.disabled=codeInput.value.length!==6;
connectBtn.onclick=()=>{conn=peer.connect(codeInput.value);wireConn();};
sendBtn.onclick=()=>requestUrl(urlInput.value);
resetCodeBtn.onclick=()=>{localStorage.removeItem("phoneCode");location.reload();};
disconnectBtn.onclick=()=>conn&&conn.close();
})();
</script>
</body>
</html>
