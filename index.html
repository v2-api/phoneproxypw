<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>

<script src="/peer.js"></script>

<style>
body {
  margin:0;
  background:#121212;
  color:#eee;
  font-family:system-ui,sans-serif;
}

/* Shared */
.hidden{display:none}

/* Phone code screen */
#phoneCodeUI {
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:1rem;
}

#phoneCode {
  font-size:3rem;
  letter-spacing:0.2rem;
  background:#1e1e1e;
  padding:1rem 2rem;
  border-radius:12px;
  border:1px solid #333;
}

#phoneConnectedUI {
  height:100vh;
  display:flex;
  flex-direction:column;
}

#phoneHeader {
  padding:1rem;
  background:#1e1e1e;
  border-bottom:1px solid #333;
  display:flex;
  justify-content:space-between;
}

#requestLog {
  flex:1;
  overflow:auto;
  padding:1rem;
  font-size:0.9rem;
}

.logRow {
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #222;
  padding:0.4rem 0;
}

.logOk {color:#6cff6c}
.logErr {color:#ff6c6c}

/* Computer UI */
#computerUI {
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:1rem;
}

#connectedUI {
  height:100vh;
  display:flex;
  flex-direction:column;
}

#topbar {
  display:flex;
  gap:0.5rem;
  padding:0.5rem;
  background:#1e1e1e;
  border-bottom:1px solid #333;
}

#urlInput {
  flex:1;
  padding:0.5rem;
  border-radius:6px;
  border:1px solid #555;
  background:#2a2a2a;
  color:#eee;
}

#sendBtn {
  padding:0.45rem 0.8rem;
  border-radius:6px;
  border:none;
  background:#0b74de;
  color:white;
  cursor:pointer;
}

iframe {
  flex:1;
  border:none;
  width:100%;
  background:white;
}
</style>
</head>

<body>

<!-- PHONE: CODE -->
<div id="phoneCodeUI" class="hidden">
  <div>Your Code</div>
  <div id="phoneCode">------</div>
  <button id="resetBtn">Reset Code</button>
</div>

<!-- PHONE: CONNECTED -->
<div id="phoneConnectedUI" class="hidden">
  <div id="phoneHeader">
    <div>
      <div>Connected âœ“</div>
      <div id="uptime">Uptime 0s</div>
    </div>
    <button id="disconnectBtn">Disconnect</button>
  </div>
  <div id="requestLog"></div>
</div>

<!-- COMPUTER: CONNECT -->
<div id="computerUI" class="hidden">
  <div>Enter Phone Code</div>
  <input id="codeInput" maxlength="6"/>
  <button id="connectBtn" disabled>Connect</button>
</div>

<!-- COMPUTER: CONNECTED -->
<div id="connectedUI" class="hidden">
  <div id="topbar">
    <input id="urlInput" placeholder="Enter URL"/>
    <button id="sendBtn">Go</button>
  </div>
  <iframe id="browserFrame"></iframe>
</div>

<script>
function startApp(){
if(!window.Peer) return setTimeout(startApp,50);

const isPhone=/Mobi|Android/i.test(navigator.userAgent);
let role=isPhone?'phone':'computer';
let peer=null,conn=null,myCode=null,uptimeTimer=null,connectTime=null;

const phoneCodeUI=phoneCodeUI=document.getElementById("phoneCodeUI");
const phoneConnectedUI=document.getElementById("phoneConnectedUI");
const phoneCodeEl=document.getElementById("phoneCode");
const uptimeEl=document.getElementById("uptime");
const requestLog=document.getElementById("requestLog");

const computerUI=document.getElementById("computerUI");
const connectedUI=document.getElementById("connectedUI");

const codeInput=document.getElementById("codeInput");
const connectBtn=document.getElementById("connectBtn");
const urlInput=document.getElementById("urlInput");
const sendBtn=document.getElementById("sendBtn");
const browserFrame=document.getElementById("browserFrame");

function show(el){el.classList.remove("hidden")}
function hide(el){el.classList.add("hidden")}

function initPeer(id){
  if(peer) return;
  peer=new Peer(id);
  peer.on("connection",c=>{conn=c;wireConn()});
}

function wireConn(){
  conn.on("open",onConnected);
  conn.on("data",onData);
  conn.on("close",onDisconnected);
}

function onConnected(){
  connectTime=Date.now();
  if(role==="phone"){
    hide(phoneCodeUI); show(phoneConnectedUI);
    uptimeTimer=setInterval(()=>uptimeEl.textContent="Uptime "+Math.floor((Date.now()-connectTime)/1000)+"s",1000);
  } else {
    hide(computerUI); show(connectedUI);
  }
}

function onDisconnected(){
  if(uptimeTimer){clearInterval(uptimeTimer);uptimeTimer=null}
  conn=null;
  if(role==="phone"){ hide(phoneConnectedUI); show(phoneCodeUI);}
  else{ hide(connectedUI); show(computerUI);}
}

async function onData(d){
  if(role==="phone"&&d.type==="fetch-request"){
    const row=document.createElement("div");
    row.className="logRow";
    row.innerHTML=`<span>${d.url}</span><span>...</span>`;
    requestLog.prepend(row);

    try{
      const r=await fetch("https://corsproxy.io/?"+encodeURIComponent(d.url));
      const t=await r.text();
      conn.send({type:"fetch-response",body:t});
      row.lastChild.textContent="OK";
      row.lastChild.className="logOk";
    }catch(e){
      conn.send({type:"fetch-response",body:"Error"});
      row.lastChild.textContent="ERR";
      row.lastChild.className="logErr";
    }
  }

  if(role==="computer"&&d.type==="fetch-response"){
    const doc=browserFrame.contentDocument;
    doc.open(); doc.write(d.body); doc.close();
  }
}

if(role==="phone"){
  myCode=localStorage.getItem("phoneCode")||String(Math.floor(100000+Math.random()*900000));
  localStorage.setItem("phoneCode",myCode);
  phoneCodeEl.textContent=myCode;
  initPeer(myCode);
  show(phoneCodeUI);
} else {
  initPeer();
  show(computerUI);
}

codeInput.oninput=()=>connectBtn.disabled=codeInput.value.length!==6;
connectBtn.onclick=()=>{conn=peer.connect(codeInput.value);wireConn()};

sendBtn.onclick=()=>conn&&conn.send({type:"fetch-request",url:urlInput.value});
document.getElementById("resetBtn").onclick=()=>{localStorage.removeItem("phoneCode");location.reload()};
document.getElementById("disconnectBtn").onclick=()=>conn&&conn.close();
}
startApp();
</script>
</body>
</html>
