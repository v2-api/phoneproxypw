<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>

<script src="/peer.js"></script>

<style>
body {
  margin:0;
  background:#121212;
  color:#eee;
  font-family: system-ui, sans-serif;
  text-align:center;
}

/* Original code box — unchanged */
.centerBox {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#1e1e1e;
  border:1px solid #333;
  border-radius:12px;
  padding:2rem;
  width:90%;
  max-width:380px;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

/* Phone connected screen */
#phoneConnectedUI {
  display:none;
  height:100vh;
  width:100vw;
  background:#0f1720;
  flex-direction:column;
}

#phoneHeader {
  padding:1rem;
  background:#111827;
  border-bottom:1px solid #1f2937;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#phoneHeader span {
  text-align:left;
}

#requestLog {
  flex:1;
  overflow:auto;
  padding:1rem;
  text-align:left;
  font-size:0.9rem;
}

.logRow {
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #1f2937;
  padding:0.4rem 0;
}

.logOk { color:#4ade80; }
.logErr { color:#f87171; }

/* Computer connected */
#connectedUI {
  display:none;
  height:100vh;
  width:100vw;
  background:#111;
  flex-direction:column;
}

#topbar {
  display:flex;
  gap:0.5rem;
  padding:0.5rem;
  background:#1e1e1e;
  border-bottom:1px solid #333;
}

#urlInput {
  flex:1;
  padding:0.5rem;
  border-radius:6px;
  border:1px solid #555;
  background:#2a2a2a;
  color:#eee;
}

#sendBtn {
  padding:0.45rem 0.8rem;
  border-radius:6px;
  border:none;
  background:#0b74de;
  color:white;
  cursor:pointer;
}

iframe {
  flex:1;
  border:none;
  width:100%;
  background:white;
}
</style>
</head>

<body>

<!-- PHONE CODE UI — UNCHANGED -->
<div class="centerBox" id="phoneUI" hidden>
  <h1>Your Code</h1>
  <div style="font-size:2rem;font-weight:bold;margin:1rem 0;" id="phoneCode">------</div>
  <button id="resetCodeBtn">Reset Code</button>
</div>

<!-- PHONE CONNECTED UI -->
<div id="phoneConnectedUI">
  <div id="phoneHeader">
    <span>
      <div>Connected ✓</div>
      <div id="uptime">Uptime 0s</div>
    </span>
    <button id="disconnectBtn">Disconnect</button>
  </div>
  <div id="requestLog"></div>
</div>

<!-- COMPUTER UI -->
<div class="centerBox" id="computerUI" hidden>
  <h1>Enter Phone Code</h1>
  <input id="codeInput" maxlength="6" placeholder="6-digit code"/>
  <button id="connectBtn" disabled>Connect</button>
</div>

<!-- COMPUTER CONNECTED -->
<div id="connectedUI">
  <div id="topbar">
    <input id="urlInput" placeholder="Enter URL"/>
    <button id="sendBtn">Go</button>
  </div>
  <iframe id="browserFrame"></iframe>
</div>

<script>
(() => {
const phoneUI=document.getElementById("phoneUI");
const phoneConnectedUI=document.getElementById("phoneConnectedUI");
const phoneCodeEl=document.getElementById("phoneCode");
const resetCodeBtn=document.getElementById("resetCodeBtn");
const uptimeEl=document.getElementById("uptime");
const requestLog=document.getElementById("requestLog");
const disconnectBtn=document.getElementById("disconnectBtn");

const computerUI=document.getElementById("computerUI");
const connectedUI=document.getElementById("connectedUI");
const codeInput=document.getElementById("codeInput");
const connectBtn=document.getElementById("connectBtn");
const urlInput=document.getElementById("urlInput");
const sendBtn=document.getElementById("sendBtn");
const browserFrame=document.getElementById("browserFrame");

let role=/Mobi|Android/i.test(navigator.userAgent)?"phone":"computer";
let peer=null,conn=null,myCode=null,uptimeTimer=null,connectTime=null;

function resetUI(){
  phoneUI.hidden=true;
  phoneConnectedUI.style.display="none";
  computerUI.hidden=true;
  connectedUI.style.display="none";
}

function showPhoneCode(){
  resetUI();
  phoneUI.hidden=false;
}

function showPhoneConnected(){
  resetUI();
  phoneConnectedUI.style.display="flex";
}

function showComputer(){
  resetUI();
  computerUI.hidden=false;
}

function showComputerConnected(){
  resetUI();
  connectedUI.style.display="flex";
}

function initPeer(id){
  if(peer) return;
  peer=new Peer(id);
  peer.on("connection",c=>{conn=c;wireConn()});
}

function wireConn(){
  conn.on("open",onConnected);
  conn.on("data",onData);
  conn.on("close",onDisconnected);
}

function onConnected(){
  connectTime=Date.now();
  if(role==="phone"){
    showPhoneConnected();
    uptimeTimer=setInterval(()=>uptimeEl.textContent="Uptime "+Math.floor((Date.now()-connectTime)/1000)+"s",1000);
  } else {
    showComputerConnected();
  }
}

function onDisconnected(){
  if(uptimeTimer){clearInterval(uptimeTimer);uptimeTimer=null;}
  conn=null;
  role==="phone"?showPhoneCode():showComputer();
}

async function onData(d){
  if(role==="phone"&&d.type==="fetch-request"){
    const row=document.createElement("div");
    row.className="logRow";
    row.innerHTML=`<span>${d.url}</span><span>...</span>`;
    requestLog.prepend(row);

    try{
      const r=await fetch("https://corsproxy.io/?"+encodeURIComponent(d.url));
      const t=await r.text();
      conn.send({type:"fetch-response",body:t});
      row.lastChild.textContent="OK";
      row.lastChild.className="logOk";
    }catch(e){
      conn.send({type:"fetch-response",body:"Error"});
      row.lastChild.textContent="ERR";
      row.lastChild.className="logErr";
    }
  }

  if(role==="computer"&&d.type==="fetch-response"){
    const doc=browserFrame.contentDocument;
    doc.open(); doc.write(d.body); doc.close();
  }
}

if(role==="phone"){
  myCode=localStorage.getItem("phoneCode")||String(Math.floor(100000+Math.random()*900000));
  localStorage.setItem("phoneCode",myCode);
  phoneCodeEl.textContent=myCode;
  initPeer(myCode);
  showPhoneCode();
} else {
  initPeer();
  showComputer();
}

codeInput.oninput=()=>connectBtn.disabled=codeInput.value.length!==6;
connectBtn.onclick=()=>{conn=peer.connect(codeInput.value);wireConn()};

sendBtn.onclick=()=>conn&&conn.send({type:"fetch-request",url:urlInput.value});
resetCodeBtn.onclick=()=>{localStorage.removeItem("phoneCode");location.reload()};
disconnectBtn.onclick=()=>conn&&conn.close();

})();
</script>
</body>
</html>
